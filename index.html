<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School QR Attendance PWA</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- HTML5-QRCode for scanning -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 1rem;
        }
        .section {
            display: none; /* Hidden by default */
        }
        .section.active {
            display: block; /* Shown when active */
        }
        .btn {
            @apply px-4 py-2 rounded-md font-medium transition duration-300;
        }
        .btn-primary {
            @apply bg-blue-600 text-white hover:bg-blue-700 shadow-md;
        }
        .btn-secondary {
            @apply bg-gray-200 text-gray-800 hover:bg-gray-300;
        }
        .input-field {
            @apply w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500;
        }
        .card {
            @apply bg-white p-6 rounded-lg shadow-md mb-4;
        }
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .message-box.error {
            background-color: #f44336;
        }
        .message-box.show {
            display: block;
            opacity: 1;
        }
        /* Style for QR scanner video feed */
        #qr-reader {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            border: 1px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
        }
        #qr-reader__dashboard_section_csr {
            display: none !important; /* Hide the dashboard section from html5-qrcode */
        }
        #qr-reader-results {
            text-align: center;
            margin-top: 1rem;
            font-weight: 600;
        }
        #qr-reader video {
            width: 100% !important;
            height: auto !important;
            border-radius: 8px;
        }
        @media (min-width: 768px) {
            .container {
                max-width: 900px;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Message Box -->
    <div id="messageBox" class="message-box"></div>

    <header class="bg-blue-700 text-white p-4 shadow-md">
        <div class="container flex justify-between items-center">
            <h1 class="text-2xl font-bold">School Attendance</h1>
            <nav id="mainNav" class="flex space-x-4">
                <!-- Navigation items will be added dynamically based on user role -->
            </nav>
            <button id="logoutBtn" class="btn btn-secondary bg-red-500 text-white hover:bg-red-600 hidden">Logout</button>
        </div>
    </header>

    <main class="flex-grow container py-8">
        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="hidden flex justify-center items-center h-full">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
        </div>

        <!-- Login Section -->
        <section id="loginSection" class="section active">
            <div class="card max-w-md mx-auto">
                <h2 class="text-2xl font-semibold mb-6 text-center">Login</h2>
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label for="loginEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="loginEmail" class="input-field" placeholder="Enter your email" required>
                    </div>
                    <div>
                        <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="loginPassword" class="input-field" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-full">Login</button>
                </form>
            </div>
        </section>

        <!-- Admin Section -->
        <section id="adminSection" class="section">
            <h2 class="text-3xl font-bold mb-6 text-center">Admin Dashboard</h2>

            <!-- User Management -->
            <div class="card">
                <h3 class="text-xl font-semibold mb-4">Manage Users</h3>
                <form id="createUserForm" class="space-y-4 mb-6">
                    <h4 class="text-lg font-medium">Create New User</h4>
                    <div>
                        <label for="userEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="userEmail" class="input-field" placeholder="User email" required>
                    </div>
                    <div>
                        <label for="userPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="userPassword" class="input-field" placeholder="User password" required>
                    </div>
                    <div>
                        <label for="userRole" class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                        <select id="userRole" class="input-field" required>
                            <option value="">Select Role</option>
                            <option value="scanner">Gate Scanner</option>
                            <option value="admin">Admin</option>
                            <option value="parent">Parent</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Create User</button>
                </form>

                <h4 class="text-lg font-medium mb-2">Existing Users</h4>
                <div id="userList" class="space-y-3">
                    <!-- User list will be populated here -->
                    <p class="text-gray-500">No users found.</p>
                </div>
            </div>

            <!-- Student Management -->
            <div class="card mt-8">
                <h3 class="text-xl font-semibold mb-4">Manage Students</h3>
                <form id="createStudentForm" class="space-y-4 mb-6">
                    <h4 class="text-lg font-medium">Add New Student</h4>
                    <div>
                        <label for="studentId" class="block text-sm font-medium text-gray-700 mb-1">Student ID (QR Code Content)</label>
                        <input type="text" id="studentId" class="input-field" placeholder="Unique Student ID (e.g., S-001)" required>
                    </div>
                    <div>
                        <label for="studentName" class="block text-sm font-medium text-gray-700 mb-1">Student Name</label>
                        <input type="text" id="studentName" class="input-field" placeholder="Student's full name" required>
                    </div>
                    <div>
                        <label for="studentGrade" class="block text-sm font-medium text-gray-700 mb-1">Grade/Class</label>
                        <input type="text" id="studentGrade" class="input-field" placeholder="e.g., Grade 5, Class A">
                    </div>
                    <div>
                        <label for="parentUids" class="block text-sm font-medium text-gray-700 mb-1">Assign Parents (Select multiple)</label>
                        <select id="parentUids" class="input-field h-32" multiple>
                            <!-- Parent options will be populated here -->
                        </select>
                        <p class="text-sm text-gray-500 mt-1">Hold Ctrl/Cmd to select multiple parents.</p>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Student</button>
                </form>

                <h4 class="text-lg font-medium mb-2">Existing Students</h4>
                <div id="studentList" class="space-y-3">
                    <!-- Student list will be populated here -->
                    <p class="text-gray-500">No students found.</p>
                </div>
            </div>
        </section>

        <!-- Scanner Section -->
        <section id="scannerSection" class="section">
            <h2 class="text-3xl font-bold mb-6 text-center">Gate Scanner</h2>
            <div class="card">
                <div id="qr-reader" class="mb-4"></div>
                <div id="qr-reader-results" class="text-lg font-semibold mb-4 text-blue-600">No QR Code Scanned</div>

                <div id="scanActionPanel" class="hidden space-y-4">
                    <p class="text-center text-xl font-medium">Student: <span id="scannedStudentName" class="font-bold text-blue-700"></span></p>
                    <div class="flex justify-center space-x-4">
                        <button id="loginScanBtn" class="btn btn-primary flex-1">Record Login</button>
                        <button id="logoutScanBtn" class="btn btn-secondary flex-1 bg-yellow-500 text-white hover:bg-yellow-600">Record Logout</button>
                    </div>
                    <div id="logoutReasonPanel" class="hidden mt-4">
                        <label for="logoutReason" class="block text-sm font-medium text-gray-700 mb-1">Reason for Logout (Optional)</label>
                        <textarea id="logoutReason" class="input-field" rows="3" placeholder="e.g., Doctor's appointment, Early dismissal"></textarea>
                    </div>
                </div>
            </div>

            <div class="card mt-8">
                <h3 class="text-xl font-semibold mb-4">Offline Scans (Pending Sync)</h3>
                <div id="offlineScansList" class="space-y-3">
                    <p class="text-gray-500">No offline scans pending.</p>
                </div>
            </div>
        </section>

        <!-- Parent Section -->
        <section id="parentSection" class="section">
            <h2 class="text-3xl font-bold mb-6 text-center">Parent Dashboard</h2>
            <div class="card">
                <h3 class="text-xl font-semibold mb-4">Your Children's Attendance</h3>
                <div id="parentNotificationsList" class="space-y-3">
                    <p class="text-gray-500">No recent attendance updates for your children.</p>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-gray-800 text-white p-4 text-center text-sm">
        <div class="container">
            &copy; 2025 School Attendance System. All rights reserved.
        </div>
    </footer>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithCustomToken,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getDatabase,
            ref,
            set,
            push,
            onValue,
            remove,
            update,
            query,
            orderByChild,
            equalTo,
            get
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // Global Firebase variables
        let app, db, auth;
        let userId = null;
        let userRole = null;
        let html5QrCode = null; // HTML5-QRCode instance

        // PWA Specifics
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }

        // Background Sync for offline data
        if ('serviceWorker' in navigator && 'SyncManager' in window) {
            navigator.serviceWorker.ready.then(reg => {
                reg.sync.register('sync-offline-scans')
                    .then(() => console.log('Background sync registered'))
                    .catch(err => console.error('Background sync registration failed:', err));
            });
        }

        // --- Utility Functions ---
        function showMessage(message, type = 'success', duration = 3000) {
            const msgBox = document.getElementById('messageBox');
            msgBox.textContent = message;
            msgBox.className = `message-box show ${type}`;
            setTimeout(() => {
                msgBox.classList.remove('show');
            }, duration);
        }

        function showLoading() {
            document.getElementById('loadingSpinner').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingSpinner').classList.add('hidden');
        }

        function hideAllSections() {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
        }

        function showSection(sectionId) {
            hideAllSections();
            document.getElementById(sectionId).classList.add('active');
        }

        function updateNavigation(role) {
            const mainNav = document.getElementById('mainNav');
            mainNav.innerHTML = ''; // Clear existing nav
            const logoutBtn = document.getElementById('logoutBtn');
            logoutBtn.classList.add('hidden');

            if (role) {
                logoutBtn.classList.remove('hidden');
            }

            if (role === 'admin') {
                mainNav.innerHTML += `<button class="btn btn-secondary" onclick="showSection('adminSection')">Admin</button>`;
            }
            if (role === 'scanner') {
                mainNav.innerHTML += `<button class="btn btn-secondary" onclick="showSection('scannerSection')">Scanner</button>`;
            }
            if (role === 'parent') {
                mainNav.innerHTML += `<button class="btn btn-secondary" onclick="showSection('parentSection')">Parent</button>`;
            }
        }

        // --- Firebase Initialization ---
        async function initializeFirebase() {
            try {
                showLoading();
                // User-provided Firebase config
                const firebaseConfig = {
                    apiKey: "AIzaSyBBPk_ZZ5OmcDXk0FZueWdnSRMgAB7zufI",
                    authDomain: "entrix-64f31.firebaseapp.com",
                    projectId: "entrix-64f31",
                    storageBucket: "entrix-64f31.firebasestorage.app",
                    messagingSenderId: "780870935360",
                    appId: "1:780870935360:web:a4ea8255ac25669cd210a5"
                };

                // Use projectId as the app ID for database paths
                const appId = firebaseConfig.projectId;

                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing. Please provide __firebase_config.");
                    showMessage("Firebase configuration error.", "error");
                    hideLoading();
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getDatabase(app);
                auth = getAuth(app);

                // Authenticate with custom token or anonymously
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User authenticated:", userId);
                        // Fetch user role from Realtime DB
                        const userRef = ref(db, `artifacts/${appId}/users/${userId}`);
                        onValue(userRef, (snapshot) => {
                            const userData = snapshot.val();
                            if (userData && userData.role) {
                                userRole = userData.role;
                                console.log("User role:", userRole);
                                showMessage(`Logged in as ${userRole}.`);
                                updateNavigation(userRole);
                                hideLoading();
                                // Redirect to appropriate section
                                if (userRole === 'admin') {
                                    showSection('adminSection');
                                    loadUsers();
                                    loadStudents();
                                    loadParentsForStudentAssignment();
                                } else if (userRole === 'scanner') {
                                    showSection('scannerSection');
                                    startQrScanner();
                                    loadOfflineScans();
                                } else if (userRole === 'parent') {
                                    showSection('parentSection');
                                    loadParentNotifications();
                                }
                            } else {
                                showMessage("User role not found. Please contact admin.", "error");
                                signOut(auth); // Log out if role is missing
                            }
                        }, {
                            onlyOnce: false // Listen for changes to user data
                        });
                    } else {
                        userId = null;
                        userRole = null;
                        console.log("User logged out or not authenticated.");
                        updateNavigation(null);
                        hideLoading();
                        showSection('loginSection');
                        stopQrScanner(); // Stop scanner if logged out
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase or authentication:", error);
                showMessage(`Firebase init error: ${error.message}`, "error");
                hideLoading();
                showSection('loginSection');
            }
        }

        // --- Login/Logout Handlers ---
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            showLoading();
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged listener will handle UI update
            } catch (error) {
                console.error("Login failed:", error);
                showMessage(`Login failed: ${error.message}`, "error");
            } finally {
                hideLoading();
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            showLoading();
            try {
                await signOut(auth);
                // onAuthStateChanged listener will handle UI update
                showMessage("Logged out successfully.");
            } catch (error) {
                console.error("Logout failed:", error);
                showMessage(`Logout failed: ${error.message}`, "error");
            } finally {
                hideLoading();
            }
        });

        // --- Admin Functions ---
        // The appId is now derived from the firebaseConfig directly
        // const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // This line is no longer needed

        // Create User
        document.getElementById('createUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('userEmail').value;
            const password = document.getElementById('userPassword').value;
            const role = document.getElementById('userRole').value;

            showLoading();
            try {
                // Create user with email/password
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const newUserId = userCredential.user.uid;

                // Save user role and details in Realtime DB
                // Ensure appId is available from initializeFirebase scope
                const currentAppId = auth.app.options.projectId; // Get projectId from initialized app
                await set(ref(db, `artifacts/${currentAppId}/users/${newUserId}`), {
                    email: email,
                    role: role,
                    createdAt: Date.now()
                });
                showMessage(`User ${email} (${role}) created successfully!`);
                document.getElementById('createUserForm').reset();
                loadUsers(); // Refresh user list
            } catch (error) {
                console.error("Error creating user:", error);
                showMessage(`Error creating user: ${error.message}`, "error");
            } finally {
                hideLoading();
            }
        });

        // Load Users for Admin Panel
        function loadUsers() {
            const userListDiv = document.getElementById('userList');
            userListDiv.innerHTML = '<p class="text-gray-500">Loading users...</p>';
            const currentAppId = auth.app.options.projectId; // Get projectId from initialized app
            const usersRef = ref(db, `artifacts/${currentAppId}/users`);

            onValue(usersRef, (snapshot) => {
                const users = snapshot.val();
                userListDiv.innerHTML = '';
                if (users) {
                    Object.entries(users).forEach(([uid, userData]) => {
                        const userCard = document.createElement('div');
                        userCard.className = 'card p-4 flex justify-between items-center';
                        userCard.innerHTML = `
                            <div>
                                <p class="font-semibold">${userData.email}</p>
                                <p class="text-sm text-gray-600">Role: ${userData.role}</p>
                                <p class="text-xs text-gray-500">UID: ${uid}</p>
                            </div>
                            <button data-uid="${uid}" class="btn btn-secondary bg-red-500 text-white hover:bg-red-600 delete-user-btn">Delete</button>
                        `;
                        userListDiv.appendChild(userCard);
                    });
                    // Add event listeners for delete buttons
                    userListDiv.querySelectorAll('.delete-user-btn').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const uidToDelete = e.target.dataset.uid;
                            if (await confirm(`Are you sure you want to delete user ${uidToDelete}? This will not delete the Firebase Auth user.`)) {
                                showLoading();
                                try {
                                    // Note: Deleting user from Realtime DB. Firebase Auth user deletion requires Admin SDK or manual deletion in console.
                                    const currentAppId = auth.app.options.projectId; // Get projectId from initialized app
                                    await remove(ref(db, `artifacts/${currentAppId}/users/${uidToDelete}`));
                                    showMessage(`User ${uidToDelete} deleted from database.`);
                                } catch (error) {
                                    console.error("Error deleting user:", error);
                                    showMessage(`Error deleting user: ${error.message}`, "error");
                                } finally {
                                    hideLoading();
                                }
                            }
                        });
                    });
                } else {
                    userListDiv.innerHTML = '<p class="text-gray-500">No users found.</p>';
                }
            });
        }

        // Load Parents for Student Assignment
        function loadParentsForStudentAssignment() {
            const parentUidsSelect = document.getElementById('parentUids');
            parentUidsSelect.innerHTML = ''; // Clear existing options
            const currentAppId = auth.app.options.projectId; // Get projectId from initialized app
            const usersRef = query(ref(db, `artifacts/${currentAppId}/users`), orderByChild('role'), equalTo('parent'));

            onValue(usersRef, (snapshot) => {
                parentUidsSelect.innerHTML = ''; // Clear existing options
                const parents = snapshot.val();
                if (parents) {
                    Object.entries(parents).forEach(([uid, userData]) => {
                        const option = document.createElement('option');
                        option.value = uid;
                        option.textContent = `${userData.email} (UID: ${uid})`;
                        parentUidsSelect.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No parents found. Create some first.';
                    option.disabled = true;
                    parentUidsSelect.appendChild(option);
                }
            });
        }

        // Add Student
        document.getElementById('createStudentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const studentId = document.getElementById('studentId').value.trim();
            const studentName = document.getElementById('studentName').value.trim();
            const studentGrade = document.getElementById('studentGrade').value.trim();
            const parentUidsSelect = document.getElementById('parentUids');
            const selectedParentUids = Array.from(parentUidsSelect.selectedOptions).map(option => option.value);

            if (!studentId || !studentName) {
                showMessage("Student ID and Name are required.", "error");
                return;
            }

            showLoading();
            try {
                const currentAppId = auth.app.options.projectId; // Get projectId from initialized app
                // Check if student ID already exists
                const studentRef = ref(db, `artifacts/${currentAppId}/students/${studentId}`);
                const snapshot = await get(studentRef);
                if (snapshot.exists()) {
                    showMessage(`Student with ID "${studentId}" already exists.`, "error");
                    hideLoading();
                    return;
                }

                const parentMap = {};
                selectedParentUids.forEach(uid => {
                    parentMap[uid] = true;
                });

                await set(studentRef, {
                    name: studentName,
                    grade: studentGrade,
                    parent_uids: parentMap,
                    createdAt: Date.now()
                });
                showMessage(`Student ${studentName} (${studentId}) added successfully!`);
                document.getElementById('createStudentForm').reset();
                loadStudents(); // Refresh student list
            } catch (error) {
                console.error("Error adding student:", error);
                showMessage(`Error adding student: ${error.message}`, "error");
            } finally {
                hideLoading();
            }
        });

        // Load Students for Admin Panel
        function loadStudents() {
            const studentListDiv = document.getElementById('studentList');
            studentListDiv.innerHTML = '<p class="text-gray-500">Loading students...</p>';
            const currentAppId = auth.app.options.projectId; // Get projectId from initialized app
            const studentsRef = ref(db, `artifacts/${currentAppId}/students`);

            onValue(studentsRef, async (snapshot) => {
                const students = snapshot.val();
                studentListDiv.innerHTML = '';
                if (students) {
                    for (const studentId in students) {
                        const studentData = students[studentId];
                        const parentNames = [];
                        if (studentData.parent_uids) {
                            for (const parentUid in studentData.parent_uids) {
                                const parentRef = ref(db, `artifacts/${currentAppId}/users/${parentUid}`);
                                const parentSnapshot = await get(parentRef);
                                if (parentSnapshot.exists()) {
                                    parentNames.push(parentSnapshot.val().email);
                                }
                            }
                        }

                        const studentCard = document.createElement('div');
                        studentCard.className = 'card p-4 flex justify-between items-center';
                        studentCard.innerHTML = `
                            <div>
                                <p class="font-semibold">${studentData.name} (ID: ${studentId})</p>
                                <p class="text-sm text-gray-600">Grade: ${studentData.grade || 'N/A'}</p>
                                <p class="text-sm text-gray-600">Parents: ${parentNames.join(', ') || 'None assigned'}</p>
                            </div>
                            <button data-id="${studentId}" class="btn btn-secondary bg-red-500 text-white hover:bg-red-600 delete-student-btn">Delete</button>
                        `;
                        studentListDiv.appendChild(studentCard);
                    }
                    // Add event listeners for delete buttons
                    studentListDiv.querySelectorAll('.delete-student-btn').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const studentIdToDelete = e.target.dataset.id;
                            if (await confirm(`Are you sure you want to delete student ${studentIdToDelete}?`)) {
                                showLoading();
                                try {
                                    const currentAppId = auth.app.options.projectId; // Get projectId from initialized app
                                    await remove(ref(db, `artifacts/${currentAppId}/students/${studentIdToDelete}`));
                                    // Also remove attendance records for this student
                                    await remove(ref(db, `artifacts/${currentAppId}/attendance_records/${studentIdToDelete}`));
                                    // And notifications related to this student (more complex, might need to iterate through parents)
                                    // For simplicity, we'll just delete the student and their attendance.
                                    showMessage(`Student ${studentIdToDelete} and their attendance records deleted.`);
                                } catch (error) {
                                    console.error("Error deleting student:", error);
                                    showMessage(`Error deleting student: ${error.message}`, "error");
                                } finally {
                                    hideLoading();
                                }
                            }
                        });
                    });
                } else {
                    studentListDiv.innerHTML = '<p class="text-gray-500">No students found.</p>';
                }
            });
        }

        // --- Scanner Functions ---
        let lastScannedStudentId = null;
        let lastScannedStudentName = null;

        function startQrScanner() {
            if (html5QrCode && html5QrCode.is  scanning) { // Check if scanner is already active
                return;
            }
            html5QrCode = new Html5Qrcode("qr-reader");
            const qrCodeSuccessCallback = async (decodedText, decodedResult) => {
                console.log(`QR Code detected: ${decodedText}`);
                document.getElementById('qr-reader-results').textContent = `Scanned: ${decodedText}`;
                lastScannedStudentId = decodedText;

                const currentAppId = auth.app.options.projectId; // Get projectId from initialized app
                // Fetch student details
                const studentRef = ref(db, `artifacts/${currentAppId}/students/${decodedText}`);
                const snapshot = await get(studentRef);
                if (snapshot.exists()) {
                    const studentData = snapshot.val();
                    lastScannedStudentName = studentData.name;
                    document.getElementById('scannedStudentName').textContent = studentData.name;
                    document.getElementById('scanActionPanel').classList.remove('hidden');
                    showMessage(`Student ${studentData.name} scanned. Choose action.`);
                } else {
                    document.getElementById('scannedStudentName').textContent = 'Unknown Student';
                    document.getElementById('scanActionPanel').classList.add('hidden');
                    showMessage("Student ID not found. Please register student first.", "error");
                }
            };
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
                .catch(err => {
                    console.error("Unable to start QR scanner:", err);
                    showMessage(`Error starting scanner: ${err.message}. Ensure camera access.`, "error");
                });
        }

        function stopQrScanner() {
            if (html5QrCode && html5QrCode.isScanning) { // Corrected property name
                html5QrCode.stop().then(() => {
                    console.log("QR scanner stopped.");
                    document.getElementById('qr-reader-results').textContent = 'No QR Code Scanned';
                    document.getElementById('scanActionPanel').classList.add('hidden');
                    lastScannedStudentId = null;
                    lastScannedStudentName = null;
                }).catch(err => {
                    console.error("Error stopping QR scanner:", err);
                });
            }
        }

        document.getElementById('loginScanBtn').addEventListener('click', () => recordAttendance('login'));
        document.getElementById('logoutScanBtn').addEventListener('click', () => {
            document.getElementById('logoutReasonPanel').classList.remove('hidden');
            // Record logout will be called after reason is entered or confirm
            recordAttendance('logout');
        });

        async function recordAttendance(type) {
            if (!lastScannedStudentId || !lastScannedStudentName) {
                showMessage("No student scanned yet.", "error");
                return;
            }

            const timestamp = Date.now();
            const reason = type === 'logout' ? document.getElementById('logoutReason').value.trim() : '';

            const attendanceRecord = {
                studentId: lastScannedStudentId,
                studentName: lastScannedStudentName,
                type: type,
                timestamp: timestamp,
                scannerUid: userId,
                reason: reason
            };

            showLoading();
            try {
                // Check network status
                if (navigator.onLine) {
                    await saveAttendanceToFirebase(attendanceRecord);
                    showMessage(`${lastScannedStudentName} ${type} recorded successfully!`);
                    document.getElementById('logoutReason').value = ''; // Clear reason
                    document.getElementById('logoutReasonPanel').classList.add('hidden');
                    document.getElementById('scanActionPanel').classList.add('hidden');
                    lastScannedStudentId = null;
                    lastScannedStudentName = null;
                } else {
                    // Save to local storage for offline sync
                    saveOfflineAttendance(attendanceRecord);
                    showMessage(`Offline: ${lastScannedStudentName} ${type} saved locally. Will sync when online.`, "success");
                    document.getElementById('logoutReason').value = ''; // Clear reason
                    document.getElementById('logoutReasonPanel').classList.add('hidden');
                    document.getElementById('scanActionPanel').classList.add('hidden');
                    lastScannedStudentId = null;
                    lastScannedStudentName = null;
                    loadOfflineScans(); // Update offline list
                }
            } catch (error) {
                console.error("Error recording attendance:", error);
                showMessage(`Error recording attendance: ${error.message}`, "error");
            } finally {
                hideLoading();
            }
        }

        async function saveAttendanceToFirebase(record) {
            const currentAppId = auth.app.options.projectId; // Get projectId from initialized app
            const attendancePath = `artifacts/${currentAppId}/attendance_records/${record.studentId}`;
            const newRecordRef = push(ref(db, attendancePath));
            await set(newRecordRef, {
                type: record.type,
                timestamp: record.timestamp,
                scannerUid: record.scannerUid,
                reason: record.reason || null
            });

            // Trigger notification for parents
            await sendNotificationToParents(record);
        }

        async function sendNotificationToParents(record) {
            const currentAppId = auth.app.options.projectId; // Get projectId from initialized app
            const studentRef = ref(db, `artifacts/${currentAppId}/students/${record.studentId}`);
            const studentSnapshot = await get(studentRef);

            if (studentSnapshot.exists()) {
                const studentData = studentSnapshot.val();
                const parentUids = studentData.parent_uids;

                let message = `${record.studentName} has ${record.type === 'login' ? 'logged in' : 'logged out'} at ${new Date(record.timestamp).toLocaleTimeString()}.`;
                if (record.type === 'logout' && record.reason) {
                    message += ` Reason: ${record.reason}`;
                }

                if (parentUids) {
                    for (const parentUid in parentUids) {
                        const notificationPath = `artifacts/${currentAppId}/notifications/${parentUid}`;
                        await push(ref(db, notificationPath), {
                            studentId: record.studentId,
                            studentName: record.studentName,
                            type: record.type,
                            timestamp: record.timestamp,
                            message: message,
                            read: false // For future read status tracking
                        });
                        console.log(`Notification sent to parent ${parentUid} for ${record.studentName}`);
                    }
                }
            }
        }

        // Offline data handling using localStorage
        const OFFLINE_SCANS_KEY = 'offlineScans';

        function saveOfflineAttendance(record) {
            let offlineScans = JSON.parse(localStorage.getItem(OFFLINE_SCANS_KEY) || '[]');
            offlineScans.push(record);
            localStorage.setItem(OFFLINE_SCANS_KEY, JSON.stringify(offlineScans));
        }

        function getOfflineScans() {
            return JSON.parse(localStorage.getItem(OFFLINE_SCANS_KEY) || '[]');
        }

        function clearOfflineScans() {
            localStorage.removeItem(OFFLINE_SCANS_KEY);
        }

        function loadOfflineScans() {
            const offlineScansListDiv = document.getElementById('offlineScansList');
            const offlineScans = getOfflineScans();
            offlineScansListDiv.innerHTML = '';
            if (offlineScans.length > 0) {
                offlineScans.forEach(scan => {
                    const item = document.createElement('div');
                    item.className = 'card p-3 bg-yellow-50 border border-yellow-200';
                    item.innerHTML = `
                        <p class="font-semibold">${scan.studentName} (${scan.studentId}) - ${scan.type.toUpperCase()}</p>
                        <p class="text-sm text-gray-600">${new Date(scan.timestamp).toLocaleString()}</p>
                        ${scan.reason ? `<p class="text-sm text-gray-600">Reason: ${scan.reason}</p>` : ''}
                    `;
                    offlineScansListDiv.appendChild(item);
                });
            } else {
                offlineScansListDiv.innerHTML = '<p class="text-gray-500">No offline scans pending.</p>';
            }
        }

        // Listen for online/offline events to trigger sync
        window.addEventListener('online', async () => {
            console.log('App is online. Attempting to sync offline data...');
            await syncOfflineData();
        });

        async function syncOfflineData() {
            const offlineScans = getOfflineScans();
            if (offlineScans.length === 0) {
                console.log('No offline scans to sync.');
                return;
            }

            showMessage(`Syncing ${offlineScans.length} offline scans...`, "success");
            showLoading();
            let successCount = 0;
            for (const record of offlineScans) {
                try {
                    await saveAttendanceToFirebase(record);
                    successCount++;
                } catch (error) {
                    console.error("Failed to sync offline record:", record, error);
                    // Keep failed records for retry or manual intervention
                }
            }

            if (successCount === offlineScans.length) {
                clearOfflineScans();
                showMessage("All offline scans synced successfully!", "success");
            } else {
                showMessage(`Synced ${successCount}/${offlineScans.length} scans. Some failed.`, "error");
                // In a real app, you'd manage failed records more robustly
            }
            loadOfflineScans(); // Refresh offline list
            hideLoading();
        }

        // --- Parent Functions ---
        function loadParentNotifications() {
            const parentNotificationsListDiv = document.getElementById('parentNotificationsList');
            parentNotificationsListDiv.innerHTML = '<p class="text-gray-500">Loading notifications...</p>';

            if (!userId) {
                parentNotificationsListDiv.innerHTML = '<p class="text-gray-500">Login to see notifications.</p>';
                return;
            }
            const currentAppId = auth.app.options.projectId; // Get projectId from initialized app
            const notificationsRef = query(
                ref(db, `artifacts/${currentAppId}/notifications/${userId}`),
                orderByChild('timestamp')
            );

            onValue(notificationsRef, (snapshot) => {
                const notifications = snapshot.val();
                parentNotificationsListDiv.innerHTML = '';
                if (notifications) {
                    const sortedNotifications = Object.values(notifications).sort((a, b) => b.timestamp - a.timestamp); // Newest first
                    sortedNotifications.forEach(notif => {
                        const notificationCard = document.createElement('div');
                        notificationCard.className = 'card p-4';
                        notificationCard.innerHTML = `
                            <p class="font-semibold text-blue-700">${notif.studentName}</p>
                            <p class="text-gray-800">${notif.message}</p>
                            <p class="text-sm text-gray-500">${new Date(notif.timestamp).toLocaleString()}</p>
                        `;
                        parentNotificationsListDiv.appendChild(notificationCard);
                    });
                } else {
                    parentNotificationsListDiv.innerHTML = '<p class="text-gray-500">No recent attendance updates for your children.</p>';
                }
            });
        }

        // --- Data Cleanup (15-day deletion) ---
        async function cleanupOldRecords() {
            console.log("Running 15-day data cleanup...");
            const fifteenDaysAgo = Date.now() - (15 * 24 * 60 * 60 * 1000); // 15 days in milliseconds
            const currentAppId = auth.app.options.projectId; // Get projectId from initialized app

            // Clean up attendance records
            const attendanceRef = ref(db, `artifacts/${currentAppId}/attendance_records`);
            const attendanceSnapshot = await get(attendanceRef);
            if (attendanceSnapshot.exists()) {
                const studentsAttendance = attendanceSnapshot.val();
                for (const studentId in studentsAttendance) {
                    const records = studentsAttendance[studentId];
                    for (const recordId in records) {
                        if (records[recordId].timestamp < fifteenDaysAgo) {
                            await remove(ref(db, `artifacts/${currentAppId}/attendance_records/${studentId}/${recordId}`));
                            console.log(`Deleted old attendance record: ${studentId}/${recordId}`);
                        }
                    }
                }
            }

            // Clean up notifications
            const notificationsRootRef = ref(db, `artifacts/${currentAppId}/notifications`);
            const notificationsRootSnapshot = await get(notificationsRootRef);
            if (notificationsRootSnapshot.exists()) {
                const parentNotifications = notificationsRootSnapshot.val();
                for (const parentUid in parentNotifications) {
                    const notifications = parentNotifications[parentUid];
                    for (const notificationId in notifications) {
                        if (notifications[notificationId].timestamp < fifteenDaysAgo) {
                            await remove(ref(db, `artifacts/${currentAppId}/notifications/${parentUid}/${notificationId}`));
                            console.log(`Deleted old notification: ${parentUid}/${notificationId}`);
                        }
                    }
                }
            }
            console.log("15-day data cleanup complete.");
        }

        // Run cleanup on app load (client-side)
        window.addEventListener('load', cleanupOldRecords);

        // Initialize Firebase on window load
        window.onload = initializeFirebase;

        // Simple confirmation dialog replacement
        window.confirm = (message) => {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center z-50';
                modal.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                        <p class="text-lg font-semibold mb-4">${message}</p>
                        <div class="flex justify-end space-x-3">
                            <button id="confirmCancelBtn" class="btn btn-secondary">Cancel</button>
                            <button id="confirmOkBtn" class="btn btn-primary">OK</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                document.getElementById('confirmOkBtn').addEventListener('click', () => {
                    modal.remove();
                    resolve(true);
                });
                document.getElementById('confirmCancelBtn').addEventListener('click', () => {
                    modal.remove();
                    resolve(false);
                });
            });
        };

    </script>
    <!-- Service Worker Script -->
    <script>
        // This script registers the service worker.
        // It's separate from the main app logic for clarity.
        // The actual service worker logic is in service-worker.js
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
